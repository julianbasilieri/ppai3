<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Encuesta</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>

    <button id="btnConsultar" class="botonConsultar" onclick="mostrarInputs()">Consultar
        Encuesta</button>

    <div id="fechaInputs" style="display: none;">
        <div>
            <label for="fechaInicio">Fecha de Inicio:</label>
            <input type="date" id="fechaInicio" required>
        </div>
        <div>
            <label for="fechaFin">Fecha de Fin:</label>
            <input type="date" id="fechaFin" required>
        </div>
        <div>
            <button onclick="limpiar(); consultarApi()" class="botonConsultar">Consultar</button>
        </div>
    </div>

    <div id="llamadasContainer"></div>

    <div id="detallesLlamada">
        <div id="fechasResultadoConsulta" style="display: none;">
            <p id="fechaInicioResultado"></p>
            <p id="fechaFinResultado"></p>
        </div>
        <h2>Resultado de la consulta:</h2>
        <table id="detalleTabla">
            <tr>
                <th>Cliente</th>
                <th>Estado</th>
                <th>Duración</th>
            </tr>
        </table>

        <h2>Datos de la encuesta del cliente:</h2>
        <table id="encuestaTabla">
            <tr>
                <th>Encuesta</th>
                <th>Pregunta</th>
                <th>Respuesta</th>
            </tr>
        </table>

        <div id="botones">
            <button id="csvButton" onclick="exportarCSV()" class="boton">CSV</button>
            <button id="imprimirButton" disabled class="boton boton-disabled">Imprimir</button>
        </div>
    </div>

    <script>
        function limpiar() {
            const llamadasContainer = document.getElementById("llamadasContainer").innerText = "";
        }

        function mostrarInputs() {
            document.getElementById("btnConsultar").style.display = "none";
            document.getElementById("fechaInputs").style.display = "flex";
        }

        function consultarApi() {
            const fechaInicio = document.getElementById("fechaInicio").value;
            const fechaFin = document.getElementById("fechaFin").value;

            if (validarFechas(fechaInicio, fechaFin)) {
                const apiUrl = `http://localhost:8080/api/llamada/selec?fi=${fechaInicio}&ff=${fechaFin}`;

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        // Mostrar fechas debajo de "Resultado de la consulta"
                        document.getElementById("fechasResultadoConsulta").style.display = "block";
                        document.getElementById("fechaInicioResultado").innerText = `Fecha de Inicio: ${fechaInicio}`;
                        document.getElementById("fechaFinResultado").innerText = `Fecha de Fin: ${fechaFin}`;

                        mostrarLlamadas(data);
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        function validarFechas(fechaInicio, fechaFin) {
            if (fechaInicio > fechaFin) {
                alert("La fecha de fin debe ser igual o posterior a la fecha de inicio.");
                return false;
            }
            return true;
        }

        function mostrarLlamadas(llamadas) {
            const llamadasContainer = document.getElementById("llamadasContainer");

            if (llamadas.length === 0) {
                // No hay datos para mostrar
                alert("No hay datos disponibles para el período seleccionado.")
            } else {
                llamadas.forEach(llamada => {
                    const llamadaButton = document.createElement("button");
                    llamadaButton.className = "llamadaButton";
                    llamadaButton.innerText = `ID de llamada: ${llamada}`;
                    llamadaButton.onclick = () => mostrarDetallesLlamada(obtenerDetallesLlamada(llamada));
                    llamadasContainer.appendChild(llamadaButton);
                });
            }
        }
        function obtenerDetallesLlamada(llamadaId) {
            const apiUrl = `http://localhost:8080/api/llamada/${llamadaId}`;
            console.log(apiUrl)

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => mostrarDetallesLlamada(data))
                .catch(error => console.error('Error:', error));
        }

        function mostrarDetallesLlamada(llamada) {
            // Ocultar botones de llamada
            document.getElementById("llamadasContainer").style.display = "none";
            document.getElementById("fechaInputs").style.display = "none";

            // Mostrar detalles de la llamada en formato de tabla
            const detalleTabla = document.getElementById("detalleTabla");
            const encuestaTabla = document.getElementById("encuestaTabla");

            // Agregar o quitar la clase 'conMargen' según sea necesario
            const fechaInputs = document.getElementById("fechaInputs");
            fechaInputs.classList.add("conMargen");

            // Limpiar tablas anteriores
            detalleTabla.innerHTML = "<tr><th>Cliente</th><th>Estado</th><th>Duración</th></tr>";
            encuestaTabla.innerHTML = "<tr><th>Encuesta</th><th>Pregunta</th><th>Respuesta</th></tr>";
            console.log(llamada)
            // Agregar datos de la llamada a la tabla de detalles
            const detalleRow = detalleTabla.insertRow();
            detalleRow.insertCell(0).innerText = llamada.cliente ? llamada.cliente : 'N/A';
            detalleRow.insertCell(1).innerText = llamada.estado;
            detalleRow.insertCell(2).innerText = llamada.duracion + " segundos";

            // Agregar datos de la encuesta a la tabla de encuesta
            llamada.respuestasCliente.forEach(respuesta => {
                const encuestaRow = encuestaTabla.insertRow();
                encuestaRow.insertCell(0).innerText = respuesta.descripcionEncuesta;
                encuestaRow.insertCell(1).innerText = respuesta.descripcionPregunta;
                encuestaRow.insertCell(2).innerText = respuesta.descripcionRespuesta;
            });

            // Mostrar la sección de detalles de la llamada
            document.getElementById("detallesLlamada").style.display = "block";

            // Agregar un margen superior constante a #fechaInputs
            document.getElementById("fechaInputs").style.marginTop = "20px";
        }

        function exportarCSV() {
            fetch('http://localhost:8080/api/exportar-csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ocurrio un error inesperado');
                    }
                    alert("Archivo generado en el escritorio");
                    return response.blob();
                })
                .catch(error => console.error('Error:', error));
        }

    </script>

</body>

</html>